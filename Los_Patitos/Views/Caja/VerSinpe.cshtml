@model IEnumerable<Los_Patitos.Models.SinpeModel>
@using Los_Patitos.Models

@{
    CajaModel? caja = ViewBag.Caja as CajaModel;
}

<div class="container mt-4">
    <h2 class="mb-4 text-primary fw-bold">
        <i class="bi bi-bank"></i> @ViewData["Title"]
    </h2>

    <!-- Información de la Caja -->
    @if (caja != null)
    {
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-primary text-white fw-bold">
                SINPE Actual de la Caja
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-md-6">
                        <p class="mb-1 fw-semibold text-secondary">Nombre de la Caja:</p>
                        <p class="fs-5">@caja.Nombre</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1 fw-semibold text-secondary">Teléfono SINPE:</p>
                        <p class="fs-5">@caja.TelefonoSINPE</p>
                    </div>
                </div>

                <div class="row mb-2">
                    <div class="col-md-6">
                        <p class="mb-1 fw-semibold text-secondary">Estado:</p>
                        <span class="badge @(caja.Estado ? "bg-success" : "bg-danger")">
                            @(caja.Estado ? "Activa" : "Inactiva")
                        </span>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1 fw-semibold text-secondary">Fecha de Registro:</p>
                        <p>@caja.FechaDeRegistro.ToString("dd/MM/yyyy HH:mm")</p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1 fw-semibold text-secondary">Última Modificación:</p>
                        <p>@((caja.FechaDeModificacion?.ToString("dd/MM/yyyy HH:mm")) ?? "Sin cambios")</p>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- SINPEs Recibidos -->
    @if (Model == null || !Model.Any())
    {
        <div class="alert alert-info mt-4 text-center shadow-sm">
            <i class="bi bi-info-circle"></i> No se han recibido SINPEs para esta caja.
        </div>
    }
    else
    {
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-secondary text-white fw-bold">
                SINPEs Recibidos
            </div>
            <div class="card-body">
                @foreach (var sinpe in Model.OrderByDescending(s => s.FechaDeRegistro))
                {
                    <div class="border rounded p-3 mb-3 bg-light">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1 fw-semibold text-secondary">Teléfono Origen:</p>
                                <p>@sinpe.TelefonoOrigen</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1 fw-semibold text-secondary">Nombre Origen:</p>
                                <p>@sinpe.NombreOrigen</p>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1 fw-semibold text-secondary">Teléfono Destinatario:</p>
                                <p>@sinpe.TelefonoDestinaria</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1 fw-semibold text-secondary">Nombre Destinatario:</p>
                                <p>@sinpe.NombreDestinaria</p>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <p class="mb-1 fw-semibold text-secondary">Monto:</p>
                                <p class="text-success fw-bold">₡@sinpe.Monto.ToString("N2")</p>
                            </div>
                            <div class="col-md-4">
                                <p class="mb-1 fw-semibold text-secondary">Fecha:</p>
                                <p>@sinpe.FechaDeRegistro.ToString("dd/MM/yyyy HH:mm")</p>
                            </div>
                            <div class="col-md-4">
                                <p class="mb-1 fw-semibold text-secondary">Estado:</p>
                                <span class="badge @(sinpe.Estado ? "bg-success" : "bg-warning text-dark")">
                                    @(sinpe.Estado ? "Sincronizado" : "No sincronizado")
                                </span>
                            </div>
                        </div>

                        <div class="mt-2">
                            <p class="mb-1 fw-semibold text-secondary">Descripción:</p>
                            <p>@(!string.IsNullOrWhiteSpace(sinpe.Descripcion) ? sinpe.Descripcion : "Sin descripción")</p>
                        </div>

                        @if (!sinpe.Estado) //Sincronizar SINPE vía API
                        {
                            <button type="button"
                                    class="btn btn-warning mt-2 fw-bold js-sincronizar-sinpe"
                                    data-id-sinpe="@sinpe.IdSinpe">
                                <i class="bi bi-arrow-repeat"></i> Sincronizar
                            </button>
                        }



                    </div>
                }
            </div>
        </div>
    }

    <div class="text-end mt-3">
        <a asp-controller="Comercio" asp-action="Index" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>


</div>
@section Scripts {
    <script>
        (function () {
            const apiBaseUrl = 'https://localhost:7271';

            const buttons = document.querySelectorAll('.js-sincronizar-sinpe');

            buttons.forEach(btn => {
                btn.addEventListener('click', async function () {
                    const idSinpe = this.dataset.idSinpe;
                    if (!idSinpe) return;

                    if (!confirm(`¿Desea sincronizar el SINPE #${idSinpe}?`)) {
                        return;
                    }

                    const button = this;
                    const originalHtml = button.innerHTML;
                    button.disabled = true;
                    button.innerHTML =
                        '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Sincronizando...';

                    try {
                        const response = await fetch(`${apiBaseUrl}/api/sinpe/sincronizar`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ idSinpe: parseInt(idSinpe) })
                        });

                        const result = await response.json();

                        if (!response.ok || !result.esValido) {
                            alert(result.mensaje || 'No fue posible sincronizar el SINPE.');
                            button.disabled = false;
                            button.innerHTML = originalHtml;
                            return;
                        }

                        //Actualizar el card
                        const card = button.closest('.border.rounded');
                        if (card) {
                            const badge = card.querySelector('.badge');
                            if (badge) {
                                badge.classList.remove('bg-warning', 'text-dark');
                                badge.classList.add('bg-success');
                                badge.textContent = 'Sincronizado';
                            }
                        }

                        button.classList.remove('btn-warning');
                        button.classList.add('btn-success');
                        button.innerHTML = '<i class="bi bi-check2-circle"></i> Sincronizado';
                    } catch (err) {
                        console.error(err);
                        alert('Error de conexión con el API.');
                        button.disabled = false;
                        button.innerHTML = originalHtml;
                    }
                });
            });
        })();
    </script>
}
